<script>var npcId = <?= ${basename(__FILE__, '.phtml').'_npc'}->getId() ?>;</script>

<h1><?= ${basename(__FILE__, '.phtml').'_npc'}->getName() ?></h1>

<br>
<p class="welp"><img src="dynamic/npcs/<?= ${basename(__FILE__, '.phtml').'_npc'}->getId() ?>.png" alt="NPC picture" /></p>
<br><hr>
<p style="text-align: center;">
    <strong>Voice actor: <br></strong>
    <?php if (${basename(__FILE__, '.phtml').'_voice_actor'} === null) : ?>
        <img id="voice-actor-avatar" class="avatarcontents" src="dynamic/avatars/nobody.png" alt="Profile picture" />
        <span id="voice-actor-name"><br><i>Nobody</i></span>
        <hr>
    <?php else : ?>
        <a class="valink" href="cast/<?= ${basename(__FILE__, '.phtml').'_voice_actor'}->getId() ?>">
            <img id="voice-actor-avatar" class="avatarcontents" src="dynamic/avatars/<?= ${basename(__FILE__, '.phtml').'_voice_actor'}->getAvatarLink() ?>" alt="Profile picture" />
            <span id="voice-actor-name"><br><?= ${basename(__FILE__, '.phtml').'_voice_actor'}->getName() ?></span>
        </a>
        <hr>
    <?php endif ?>
    <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
        <p style="text-align: center;"><button id="change-actor-btn">Change</button></p><br>
        <form id="voice-actor-form">
            <select name="actor">
                <?php if (${basename(__FILE__, '.phtml').'_voice_actor'} === null) : ?>
                    <option selected disabled hidden></option>
                <?php endif ?>
                <?php foreach (${basename(__FILE__, '.phtml').'_voice_actors'} as $vactor) : ?>
                    <?php if (!${basename(__FILE__, '.phtml').'_voice_actor'} === null && ${basename(__FILE__, '.phtml').'_voice_actor'}->getId() === $vactor->getId) : ?>
                    <option checked value="<?= $vactor->getId() ?>" data-avatar-link="<?= $vactor->getAvatarLink() ?>"><?= $vactor->getName() ?></option>
                    <?php else : ?>
                    <option value="<?= $vactor->getId() ?>" data-avatar-link="<?= $vactor->getAvatarLink() ?>"><?= $vactor->getName() ?></option>
                    <?php endif ?>
                <?php endforeach ?>
            </select><br><br>
            <input type="submit" value="Confirm" id="va-confirm-change"/>
        </form>
        <hr>
    <?php endif ?>
</p>

<h3 style="text-align: center;">Recordings</h3>
<?php foreach (${basename(__FILE__, '.phtml').'_quest_recordings'} as $quest) : ?>

<div class="reccenter">
<section class="table-center">
    <table>
        <tr>
            <th colspan="<?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>6<?php else : ?>5<?php endif ?>"><?= $quest->getName() ?></th>
        </tr>
	    <?php $recordings = $quest->getNpcs()[0]->getRecordings(); ?>
        <?php foreach ($recordings as $recording) : ?>
        <tr>
            <td># <?= $recording->line ?></td>
            <td>
                <audio controls>
                    <source src="dynamic/recordings/<?= $recording->file ?>" type="audio/ogg">
                    Your browser does not support the OGG audio format.
                </audio>
            </td>
            <td>
                <button class="upvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_upvoted'})) : ?> clicked<?php endif ?>" data-recording-id="<?= $recording->id ?>" data-npc-id="<?= $recording->npcId ?>">üëç (<span><?= $recording->upvotes ?></span>)</button>
            </td>
            <td>
                <button class="downvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_downvoted'})) : ?> clicked<?php endif ?>" data-recording-id="<?= $recording->id ?>" data-npc-id="<?= $recording->npcId ?>">üëé (<span><?= $recording->downvotes ?></span>)</button>
            </td>
            <td>
                <a href="contents/npc/<?= $recording->npcId ?>/comments/<?= $recording->id ?>"><button class="commentbtn">üí¨ (<span><?= $recording->comments ?></span>)</button></a>
            </td>
            <td>
                <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
                    <button class="delete-recording-btn" data-recording-id="<?= $recording->id ?>">√ó</button>
                <?php endif ?>
            </td>
        </tr>
        <?php endforeach ?>
    </table>
    <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
        <form method="post" enctype="multipart/form-data" class="new-recording-form">
            <h4>Add new recording</h4>
            <input name="questId" type="hidden" value="<?= $quest->getId() ?>" />
            <table>
                <tr><th>File</th><th>Line #</th></tr>
                <tbody class="new-recording-items-container">
                    <tr class="new-recording-item">
                        <td>
                            <input name="recording1" type="file" accept="audio/ogg" class="recording-input" required/>
                        </td>
                        <td>
                            <?php if (empty($recordings)) : ?>
                                <input name="line1" type="number" min="1" max="32767" value="1" class="line-input" required/>
                            <?php else : ?>
                                <input name="line1" type="number" min="1" max="32767" value="<?= $recordings[count($recordings) -1]->line+1 ?>" class="line-input" required/>
                            <?php endif ?>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button class="add-more-recordings-button">Add more</button>
            <input type="submit" value="Upload"/>
        </form>
        <?php if (isset(${basename(__FILE__, '.phtml').'_uploadErrors'}[$quest->getId()])) : ?>
            <?= ${basename(__FILE__, '.phtml').'_uploadErrors'}[$quest->getId()] ?>
        <?php endif ?>
    <?php endif ?>
</section>
</div>

<?php endforeach ?>

<br>
<button class="backbtn" onclick="history.go(-1)">< Go Back</button>

