<script>var npcId = <?= json_encode(${basename(__FILE__, '.phtml').'_npc'}->getId()) ?>;</script>

<!-- Hero Section -->
<section class="npc-hero npc-animate-fade-in">
    <div class="npc-hero-content">
        <h1 class="npc-hero-title">
            <?= htmlspecialchars(${basename(__FILE__, '.phtml').'_npc'}->getName(), ENT_QUOTES, 'UTF-8') ?>
            <?php if (${basename(__FILE__, '.phtml').'_npc'}->isArchived()) : ?>
                <span class="outdated-tag">outdated</span>
            <?php endif ?>
        </h1>
        <img class="npc-avatar" src="<?= htmlspecialchars(\VoicesOfWynn\storageUrl('npcs/' . ${basename(__FILE__, '.phtml').'_npc'}->getId() . '.png'), ENT_QUOTES, 'UTF-8') ?>" alt="NPC picture" />
    </div>
</section>

<!-- Voice Actor Card -->
<section class="voice-actor-card npc-animate-on-scroll">
    <h3>Voice Actor</h3>

    <?php if (${basename(__FILE__, '.phtml').'_voice_actor'} === null) : ?>
        <div class="voice-actor-info">
            <img class="voice-actor-avatar" src="<?= htmlspecialchars(\VoicesOfWynn\storageUrl('avatars/nobody.png'), ENT_QUOTES, 'UTF-8') ?>" alt="Profile picture" />
            <span class="voice-actor-name unassigned">Nobody</span>
        </div>
    <?php else : ?>
        <a class="voice-actor-link" href="cast/<?= htmlspecialchars(${basename(__FILE__, '.phtml').'_voice_actor'}->getId(), ENT_QUOTES, 'UTF-8') ?>">
            <img class="voice-actor-avatar" src="<?= htmlspecialchars(${basename(__FILE__, '.phtml').'_voice_actor'}->getAvatarLink(), ENT_QUOTES, 'UTF-8') ?>" onerror="this.onerror=null; this.src='<?= htmlspecialchars(${basename(__FILE__, '.phtml').'_voice_actor'}->getDefaultAvatarUrl(), ENT_QUOTES, 'UTF-8') ?>'" alt="Profile picture" />
            <span class="voice-actor-name"><?= htmlspecialchars(${basename(__FILE__, '.phtml').'_voice_actor'}->getName(), ENT_QUOTES, 'UTF-8') ?></span>
        </a>
    <?php endif ?>

    <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
        <div class="admin-controls">
            <button id="change-actor-btn">Change</button>
            <button id="archive-btn">Archive NPC</button>
        </div>
        <form id="voice-actor-form">
            <select name="actor">
                <?php if (${basename(__FILE__, '.phtml').'_voice_actor'} === null) : ?>
                    <option selected disabled hidden></option>
                <?php endif ?>
                <?php foreach (${basename(__FILE__, '.phtml').'_voice_actors'} as $vactor) : ?>
                    <?php if (${basename(__FILE__, '.phtml').'_voice_actor'} !== null && ${basename(__FILE__, '.phtml').'_voice_actor'}->getId() === $vactor->getId()) : ?>
                        <option selected value="<?= $vactor->getId() ?>" data-avatar-link="<?= htmlspecialchars($vactor->getAvatarLink(), ENT_QUOTES, 'UTF-8') ?>"><?= htmlspecialchars($vactor->getName(), ENT_QUOTES, 'UTF-8') ?></option>
                    <?php else : ?>
                        <option value="<?= $vactor->getId() ?>" data-avatar-link="<?= htmlspecialchars($vactor->getAvatarLink(), ENT_QUOTES, 'UTF-8') ?>"><?= htmlspecialchars($vactor->getName(), ENT_QUOTES, 'UTF-8') ?></option>
                    <?php endif ?>
                <?php endforeach ?>
            </select>
            <input type="submit" value="Confirm" id="va-confirm-change"/>
        </form>
    <?php endif ?>
</section>

<!-- Recordings Section -->
<section class="recordings-section">
    <h2 class="recordings-section-title">Recordings</h2>

    <?php foreach (${basename(__FILE__, '.phtml').'_quest_recordings'} as $quest) : ?>
        <article class="quest-card npc-animate-on-scroll">
            <header class="quest-card-header">
                <?= htmlspecialchars($quest->getName(), ENT_QUOTES, 'UTF-8') ?>
            </header>
            <div class="quest-card-body">
                <?php
                    $npcs = $quest->getNpcs();
                    $recordings = !empty($npcs) ? $npcs[0]->getRecordings() : [];
                ?>
                <?php foreach ($recordings as $recording) : ?>
                    <div class="recording-row">
                        <span class="recording-line-number"><?= htmlspecialchars($recording->line, ENT_QUOTES, 'UTF-8') ?></span>
                        <!-- Native audio player (hidden, kept for fallback) -->
                        <div class="recording-audio recording-audio--native">
                            <audio controls preload="none">
                                <source src="<?= htmlspecialchars(\VoicesOfWynn\storageUrl('recordings/' . $recording->file), ENT_QUOTES, 'UTF-8') ?>" type="audio/ogg">
                            </audio>
                        </div>
                        <!-- Custom audio player component -->
                        <?php $audioSrc = htmlspecialchars(\VoicesOfWynn\storageUrl('recordings/' . $recording->file), ENT_QUOTES, 'UTF-8'); ?>
                        <?php include 'Views/partials/audio-player.phtml'; ?>
                        <div class="recording-actions">
                            <button class="vote-btn upvote-btn upvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_upvoted'})) : ?> clicked<?php endif ?>" data-recording-id="<?= htmlspecialchars($recording->id, ENT_QUOTES, 'UTF-8') ?>" data-npc-id="<?= htmlspecialchars($recording->npcId, ENT_QUOTES, 'UTF-8') ?>">
                                <span class="vote-icon">üëç</span>
                                <span class="vote-count"><?= $recording->upvotes ?></span>
                            </button>
                            <button class="vote-btn downvote-btn downvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_downvoted'})) : ?> clicked<?php endif ?>" data-recording-id="<?= htmlspecialchars($recording->id, ENT_QUOTES, 'UTF-8') ?>" data-npc-id="<?= htmlspecialchars($recording->npcId, ENT_QUOTES, 'UTF-8') ?>">
                                <span class="vote-icon">üëé</span>
                                <span class="vote-count"><?= $recording->downvotes ?></span>
                            </button>
                            <a href="contents/npc/<?= htmlspecialchars($recording->npcId, ENT_QUOTES, 'UTF-8') ?>/comments/<?= htmlspecialchars($recording->id, ENT_QUOTES, 'UTF-8') ?>" class="vote-btn comment-btn">
                                <span class="vote-icon">üí¨</span>
                                <span class="vote-count"><?= $recording->comments ?></span>
                            </a>
                            <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
                                <button class="delete-recording-btn" data-recording-id="<?= htmlspecialchars($recording->id, ENT_QUOTES, 'UTF-8') ?>">√ó</button>
                            <?php endif ?>
                        </div>
                    </div>
                <?php endforeach ?>
            </div>
            <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
                <div class="quest-admin-actions">
                    <button class="archive-all-recordings-btn" data-quest-id="<?= htmlspecialchars($quest->getId(), ENT_QUOTES, 'UTF-8') ?>">Archive all recordings</button>
                    <a href="/administration/upload?questId=<?= htmlspecialchars($quest->getId(), ENT_QUOTES, 'UTF-8') ?>&amp;npcId=<?= htmlspecialchars(${basename(__FILE__, '.phtml').'_npc'}->getId(), ENT_QUOTES, 'UTF-8') ?>" class="uploadbtn">Add new recordings</a>
                </div>
            <?php endif ?>
        </article>
    <?php endforeach ?>
</section>

<!-- Back Button -->
<div class="back-btn-container">
    <button class="backbtn" onclick="history.go(-1)">‚Üê Go Back</button>
</div>
