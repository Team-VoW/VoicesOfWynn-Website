<script>var npcId = <?= ${basename(__FILE__, '.phtml').'_npc'}->getId() ?>;</script>

<!-- Hero Section -->
<section class="npc-hero npc-animate-fade-in">
    <div class="npc-hero-content">
        <h1 class="npc-hero-title">
            <?= htmlspecialchars(${basename(__FILE__, '.phtml').'_npc'}->getName(), ENT_QUOTES, 'UTF-8') ?>
            <?php if (${basename(__FILE__, '.phtml').'_npc'}->isArchived()) : ?>
                <span class="outdated-tag">outdated</span>
            <?php endif ?>
        </h1>
        <img class="npc-avatar" src="<?= \VoicesOfWynn\storageUrl('npcs/' . ${basename(__FILE__, '.phtml').'_npc'}->getId() . '.png') ?>" alt="NPC picture" />
    </div>
</section>

<!-- Voice Actor Card -->
<section class="voice-actor-card npc-animate-on-scroll">
    <h3>Voice Actor</h3>

    <?php if (${basename(__FILE__, '.phtml').'_voice_actor'} === null) : ?>
        <div class="voice-actor-info">
            <img id="voice-actor-avatar" class="voice-actor-avatar" src="<?= \VoicesOfWynn\storageUrl('avatars/nobody.png') ?>" alt="Profile picture" />
            <span id="voice-actor-name" class="voice-actor-name unassigned">Nobody</span>
        </div>
    <?php else : ?>
        <a class="voice-actor-link" href="cast/<?= ${basename(__FILE__, '.phtml').'_voice_actor'}->getId() ?>">
            <img id="voice-actor-avatar" class="voice-actor-avatar" src="<?= ${basename(__FILE__, '.phtml').'_voice_actor'}->getAvatarLink() ?>" onerror="this.onerror=null; this.src='<?= ${basename(__FILE__, '.phtml').'_voice_actor'}->getDefaultAvatarUrl() ?>'" alt="Profile picture" />
            <span id="voice-actor-name" class="voice-actor-name"><?= htmlspecialchars(${basename(__FILE__, '.phtml').'_voice_actor'}->getName(), ENT_QUOTES, 'UTF-8') ?></span>
        </a>
    <?php endif ?>

    <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
        <div class="admin-controls">
            <button id="change-actor-btn">Change</button>
            <button id="archive-btn">Archive NPC</button>
        </div>
        <form id="voice-actor-form">
            <select name="actor">
                <?php if (${basename(__FILE__, '.phtml').'_voice_actor'} === null) : ?>
                    <option selected disabled hidden></option>
                <?php endif ?>
                <?php foreach (${basename(__FILE__, '.phtml').'_voice_actors'} as $vactor) : ?>
                    <?php if (!${basename(__FILE__, '.phtml').'_voice_actor'} === null && ${basename(__FILE__, '.phtml').'_voice_actor'}->getId() === $vactor->getId) : ?>
                        <option selected value="<?= $vactor->getId() ?>" data-avatar-link="<?= htmlspecialchars($vactor->getAvatarLink(), ENT_QUOTES, 'UTF-8') ?>"><?= htmlspecialchars($vactor->getName(), ENT_QUOTES, 'UTF-8') ?></option>
                    <?php else : ?>
                        <option value="<?= $vactor->getId() ?>" data-avatar-link="<?= htmlspecialchars($vactor->getAvatarLink(), ENT_QUOTES, 'UTF-8') ?>"><?= htmlspecialchars($vactor->getName(), ENT_QUOTES, 'UTF-8') ?></option>
                    <?php endif ?>
                <?php endforeach ?>
            </select>
            <input type="submit" value="Confirm" id="va-confirm-change"/>
        </form>
    <?php endif ?>
</section>

<!-- Recordings Section -->
<section class="recordings-section">
    <h2 class="recordings-section-title">Recordings</h2>

    <?php foreach (${basename(__FILE__, '.phtml').'_quest_recordings'} as $quest) : ?>
        <article class="quest-card npc-animate-on-scroll">
            <header class="quest-card-header">
                <?= htmlspecialchars($quest->getName(), ENT_QUOTES, 'UTF-8') ?>
            </header>
            <div class="quest-card-body">
                <?php $recordings = $quest->getNpcs()[0]->getRecordings(); ?>
                <?php foreach ($recordings as $recording) : ?>
                    <div class="recording-row">
                        <span class="recording-line-number"><?= $recording->line ?></span>
                        <!-- Native audio player (shown on larger screens) -->
                        <div class="recording-audio recording-audio--native">
                            <audio controls preload="none">
                                <source src="<?= \VoicesOfWynn\storageUrl('recordings/' . $recording->file) ?>" type="audio/ogg">
                            </audio>
                        </div>
                        <!-- Custom audio player component -->
                        <?php $audioSrc = \VoicesOfWynn\storageUrl('recordings/' . $recording->file); ?>
                        <?php include 'Views/partials/audio-player.phtml'; ?>
                        <!-- Vote buttons (stacked on mobile, inline on desktop) -->
                        <div class="recording-actions">
                            <button class="vote-btn upvote-btn upvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_upvoted'})) : ?> clicked<?php endif ?>" data-recording-id="<?= $recording->id ?>" data-npc-id="<?= $recording->npcId ?>">
                                <span class="vote-icon">üëç</span>
                                <span class="vote-count"><?= $recording->upvotes ?></span>
                            </button>
                            <button class="vote-btn downvote-btn downvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_downvoted'})) : ?> clicked<?php endif ?>" data-recording-id="<?= $recording->id ?>" data-npc-id="<?= $recording->npcId ?>">
                                <span class="vote-icon">üëé</span>
                                <span class="vote-count"><?= $recording->downvotes ?></span>
                            </button>
                            <a href="contents/npc/<?= $recording->npcId ?>/comments/<?= $recording->id ?>">
                                <button class="vote-btn comment-btn">
                                    <span class="vote-icon">üí¨</span>
                                    <span class="vote-count"><?= $recording->comments ?></span>
                                </button>
                            </a>
                            <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
                                <button class="delete-recording-btn" data-recording-id="<?= $recording->id ?>">√ó</button>
                            <?php endif ?>
                        </div>
                    </div>
                <?php endforeach ?>
            </div>
            <?php if (${basename(__FILE__, '.phtml').'_admin'}) : ?>
                <div class="quest-admin-actions">
                    <button class="archive-all-recordings-btn" data-quest-id="<?= $quest->getId() ?>">Archive all recordings</button>
                    <a href="/administration/upload?questId=<?= $quest->getId() ?>&npcId=<?= ${basename(__FILE__, '.phtml').'_npc'}->getId() ?>">
                        <button class="uploadbtn">Add new recordings</button>
                    </a>
                </div>
            <?php endif ?>
        </article>
    <?php endforeach ?>
</section>

<!-- Back Button -->
<div class="back-btn-container">
    <button class="backbtn" onclick="history.go(-1)">‚Üê Go Back</button>
</div>
