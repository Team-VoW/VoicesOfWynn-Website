<?php
  $voiceActor = ${basename(__FILE__, '.phtml').'_voice_actor'};
  const SOCIALS = ['twitter','youtube','castingcallclub'];
  const SOCIAL_PRE_LINK = ['youtube' => '', 'twitter' => 'https://twitter.com/', 'castingcallclub' => 'https://castingcall.club/'];
  const SOCIAL_ICONS = ['youtube' =>'images/youtube_icon.png', 'twitter' => 'images/twitter_icon.png', 'castingcallclub' => 'images/castingcallclub_icon.png'];
  const SOCIAL_NAME = ['youtube' => 'YouTube', 'twitter' => 'Twitter', 'castingcallclub' => 'Casting Call Club'];
?>

<header class="cast-header">
    <div class="cast-profile-card">
        <img
            class="cast-avatar"
            src="<?= $voiceActor->getAvatarLink() ?>"
            onerror="this.onerror=null; this.src='<?= $voiceActor->getDefaultAvatarUrl() ?>'"
            alt="<?= htmlspecialchars($voiceActor->getName()) ?>'s avatar"
        />
        <h1 class="cast-name"><?= $voiceActor->getName(); ?></h1>
        <div class="cast-roles">
            <?php foreach ($voiceActor->getRoles() as $role) : ?>
            <span class="cast-role-badge" style="--role-color: #<?= $role->color ?>;">
                <?= $role->name ?>
            </span>
            <?php endforeach ?>
        </div>
    </div>
</header>

<section class="cast-contact-section">
    <?php if (!empty($voiceActor->getSocial('discord'))) : ?>
    <div class="cast-discord">
        <img src="images/discord_icon.png" alt="Discord" class="social-icon" />
        <span class="discord-tag"><?= $voiceActor->getSocial('discord') ?></span>
    </div>
    <?php endif ?>

    <div class="cast-social-links">
        <?php foreach(SOCIALS as $social): ?>
            <?php if($voiceActor->getSocial($social)): ?>
            <a
                href="<?= SOCIAL_PRE_LINK[$social] . $voiceActor->getSocial($social) ?>"
                target="_blank"
                rel="noopener noreferrer"
                class="cast-social-btn cast-social-<?= $social ?>"
            >
                <img src="<?= SOCIAL_ICONS[$social] ?>" alt="" class="social-btn-icon" />
                <span class="social-btn-label">
                    <?= $social === 'youtube' ? SOCIAL_NAME[$social] : $voiceActor->getSocial($social) ?>
                </span>
            </a>
            <?php endif; ?>
        <?php endforeach; ?>

        <?php if (!empty($voiceActor->getEmail()) && $voiceActor->hasPublicEmail()) : ?>
        <a href="mailto:<?= $voiceActor->getEmail() ?>" class="cast-social-btn cast-social-contact">
            <span class="social-btn-icon-text">&#9993;</span>
            <span class="social-btn-label">Contact</span>
        </a>
        <?php endif ?>
    </div>
</section>

<?php if (!empty($voiceActor->getBio())) : ?>
<section class="cast-bio-section">
    <h2 class="cast-section-title">About</h2>
    <div class="cast-bio-card">
        <article class="cast-bio-content">
            <?= $voiceActor->getBio(); ?>
        </article>
    </div>
</section>
<?php endif ?>

<section class="cast-recordings-section">
    <h2 class="cast-section-title">Recordings</h2>

    <?php if (count(${basename(__FILE__, '.phtml').'_quest_recordings'}) === 0) : ?>
    <p class="cast-no-recordings">
        <em>This contributor hasn't submitted any recordings yet.</em>
    </p>
    <?php endif ?>

    <?php foreach (${basename(__FILE__, '.phtml').'_quest_recordings'} as $quest) : ?>
    <div class="cast-quest-card">
        <div class="cast-quest-header">
            <h3 class="cast-quest-title">
                <a href="/contents/npc/<?= $quest->getNpcs()[0]->getId() ?>" class="cast-npc-link">
                    <span class="cast-npc-name"><?= $quest->getNpcs()[0]->getName() ?></span>
                </a>
                <span class="cast-quest-separator">in</span>
                <span class="cast-quest-name"><?= $quest->getName() ?></span>
                <?php if ($quest->getNpcs()[0]->isArchived()) : ?>
                <span class="cast-archived-badge">outdated</span>
                <?php endif ?>
            </h3>
        </div>

        <div class="cast-recordings-list">
            <?php $recordings = $quest->getNpcs()[0]->getRecordings(); ?>
            <?php foreach ($recordings as $recording) : ?>
            <div class="cast-recording-item voting-audio-box">
                <div class="cast-recording-line">
                    <span class="line-number"># <?= $recording->line ?></span>
                </div>

                <div class="cast-recording-player">
                    <?php $audioSrc = \VoicesOfWynn\storageUrl('recordings/' . $recording->file); ?>
                    <?php include 'Views/partials/audio-player.phtml'; ?>
                </div>

                <div class="cast-recording-actions">
                    <button
                        class="cast-vote-btn upvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_upvoted'})) : ?> clicked<?php endif ?>"
                        data-recording-id="<?= $recording->id ?>"
                        data-npc-id="<?= $recording->npcId ?>"
                    >
                        <span class="vote-icon">&#128077;</span>
                        <span class="vote-count"><?= $recording->upvotes ?></span>
                    </button>

                    <button
                        class="cast-vote-btn downvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml').'_downvoted'})) : ?> clicked<?php endif ?>"
                        data-recording-id="<?= $recording->id ?>"
                        data-npc-id="<?= $recording->npcId ?>"
                    >
                        <span class="vote-icon">&#128078;</span>
                        <span class="vote-count"><?= $recording->downvotes ?></span>
                    </button>

                    <a href="contents/npc/<?= $recording->npcId ?>/comments/<?= $recording->id ?>" class="cast-comment-link">
                        <button class="cast-comment-btn">
                            <span class="vote-icon">&#128172;</span>
                            <span class="vote-count"><?= $recording->comments ?></span>
                        </button>
                    </a>
                </div>
            </div>
            <?php endforeach ?>
        </div>
    </div>
    <?php endforeach ?>
</section>

<div class="cast-back-wrapper">
    <button class="cast-back-btn" onclick="history.go(-1)">
        <span class="back-arrow">&larr;</span> Go Back
    </button>
</div>
