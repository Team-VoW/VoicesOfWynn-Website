<?php
$voiceActor = ${basename(__FILE__, '.phtml') . '_voice_actor'};
const SOCIALS = ['twitter', 'youtube', 'castingcallclub'];
const SOCIAL_PRE_LINK = ['youtube' => '', 'twitter' => 'https://twitter.com/', 'castingcallclub' => 'https://castingcall.club/'];
const SOCIAL_ICONS = ['youtube' => 'images/youtube_icon.png', 'twitter' => 'images/twitter_icon.png', 'castingcallclub' => 'images/castingcallclub_icon.png'];
const SOCIAL_NAME = ['youtube' => 'YouTube', 'twitter' => 'Twitter', 'castingcallclub' => 'Casting Call Club'];
?>

<header class="cast-header">
    <div class="cast-profile-card">
        <img class="cast-avatar" src="<?= htmlspecialchars($voiceActor->getAvatarLink(), ENT_QUOTES, 'UTF-8') ?>"
            onerror="this.onerror=null; this.src='<?= htmlspecialchars($voiceActor->getDefaultAvatarUrl(), ENT_QUOTES, 'UTF-8') ?>'"
            alt="<?= htmlspecialchars($voiceActor->getName(), ENT_QUOTES, 'UTF-8') ?>'s avatar" />
        <h1 class="cast-name"><?= htmlspecialchars($voiceActor->getName(), ENT_QUOTES, 'UTF-8'); ?></h1>
        <div class="cast-roles">
            <?php foreach ($voiceActor->getRoles() as $role): ?>
                <span class="cast-role-badge"
                    style="--role-color: #<?= preg_match('/^[0-9A-Fa-f]{6}$/', $role->color) ? $role->color : '000000' ?>;">
                    <?= htmlspecialchars($role->name, ENT_QUOTES, 'UTF-8') ?>
                </span>
            <?php endforeach ?>
        </div>
    </div>
</header>

<section class="cast-contact-section">
    <?php if (!empty($voiceActor->getSocial('discord'))): ?>
        <div class="cast-discord">
            <img src="images/discord_icon.png" alt="Discord" class="social-icon" />
            <span class="discord-tag"><?= htmlspecialchars($voiceActor->getSocial('discord'), ENT_QUOTES, 'UTF-8') ?></span>
        </div>
    <?php endif ?>

    <div class="cast-social-links">
        <?php foreach (SOCIALS as $social): ?>
            <?php if ($voiceActor->getSocial($social)): ?>
                <a href="<?= htmlspecialchars(SOCIAL_PRE_LINK[$social] . $voiceActor->getSocial($social), ENT_QUOTES, 'UTF-8') ?>"
                    target="_blank" rel="noopener noreferrer"
                    class="cast-social-btn cast-social-<?= htmlspecialchars($social, ENT_QUOTES, 'UTF-8') ?>">
                    <img src="<?= htmlspecialchars(SOCIAL_ICONS[$social], ENT_QUOTES, 'UTF-8') ?>" alt=""
                        class="social-btn-icon" />
                    <span class="social-btn-label">
                        <?= $social === 'youtube' ? htmlspecialchars(SOCIAL_NAME[$social], ENT_QUOTES, 'UTF-8') : htmlspecialchars($voiceActor->getSocial($social), ENT_QUOTES, 'UTF-8') ?>
                    </span>
                </a>
            <?php endif; ?>
        <?php endforeach; ?>

        <?php if (!empty($voiceActor->getEmail()) && $voiceActor->hasPublicEmail()): ?>
            <a href="mailto:<?= htmlspecialchars($voiceActor->getEmail(), ENT_QUOTES, 'UTF-8') ?>"
                class="cast-social-btn cast-social-contact">
                <span class="social-btn-icon-text">&#9993;</span>
                <span class="social-btn-label">Contact</span>
            </a>
        <?php endif ?>
    </div>
</section>

<?php if (!empty($voiceActor->getBio())): ?>
    <section class="cast-bio-section">
        <h2 class="cast-section-title">About</h2>
        <div class="cast-bio-card">
            <article class="cast-bio-content">
                <?php // Bio is already sanitized by HTMLPurifier in AccountDataValidator::sanitizeBio() before saving, so no escaping needed here ?>
                <?= $voiceActor->getBio() ?>
            </article>
        </div>
    </section>
<?php endif ?>

<section class="cast-recordings-section">
    <h2 class="cast-section-title">Recordings</h2>

    <?php if (count(${basename(__FILE__, '.phtml') . '_quest_recordings'}) === 0): ?>
        <p class="cast-no-recordings">
            <em>This contributor hasn't submitted any recordings yet.</em>
        </p>
    <?php endif ?>

    <?php foreach (${basename(__FILE__, '.phtml') . '_quest_recordings'} as $quest): ?>
        <?php
        $npcs = $quest->getNpcs();
        $firstNpc = !empty($npcs) ? $npcs[0] : null;
        ?>
        <?php if ($firstNpc !== null): ?>
        <div class="cast-quest-card">
            <div class="cast-quest-header">
                <h3 class="cast-quest-title">
                    <a href="/contents/npc/<?= urlencode($firstNpc->getId()) ?>" class="cast-npc-link">
                        <span
                            class="cast-npc-name"><?= htmlspecialchars($firstNpc->getName(), ENT_QUOTES, 'UTF-8') ?></span>
                    </a>
                    <span class="cast-quest-separator">in</span>
                    <span class="cast-quest-name"><?= htmlspecialchars($quest->getName(), ENT_QUOTES, 'UTF-8') ?></span>
                    <?php if ($firstNpc->isArchived()): ?>
                        <span class="cast-archived-badge">outdated</span>
                    <?php endif ?>
                </h3>
            </div>

            <div class="cast-recordings-list">
                <?php $recordings = $firstNpc->getRecordings(); ?>
                <?php foreach ($recordings as $recording): ?>
                    <div class="cast-recording-item voting-audio-box">
                        <div class="cast-recording-line">
                            <span class="line-number"># <?= htmlspecialchars($recording->line, ENT_QUOTES, 'UTF-8') ?></span>
                        </div>

                        <div class="cast-recording-player">
                            <?php $audioSrc = \VoicesOfWynn\storageUrl('recordings/' . $recording->file); ?>
                            <?php include 'Views/partials/audio-player.phtml'; ?>
                        </div>

                        <div class="cast-recording-actions">
                            <button
                                class="cast-vote-btn upvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml') . '_upvoted'})): ?> clicked<?php endif ?>"
                                data-recording-id="<?= htmlspecialchars($recording->id, ENT_QUOTES, 'UTF-8') ?>"
                                data-npc-id="<?= htmlspecialchars($recording->npcId, ENT_QUOTES, 'UTF-8') ?>">
                                <span class="vote-icon">&#128077;</span>
                                <span
                                    class="vote-count"><?= htmlspecialchars($recording->upvotes, ENT_QUOTES, 'UTF-8') ?></span>
                            </button>

                            <button
                                class="cast-vote-btn downvote<?php if (in_array($recording->id, ${basename(__FILE__, '.phtml') . '_downvoted'})): ?> clicked<?php endif ?>"
                                data-recording-id="<?= htmlspecialchars($recording->id, ENT_QUOTES, 'UTF-8') ?>"
                                data-npc-id="<?= htmlspecialchars($recording->npcId, ENT_QUOTES, 'UTF-8') ?>">
                                <span class="vote-icon">&#128078;</span>
                                <span
                                    class="vote-count"><?= htmlspecialchars($recording->downvotes, ENT_QUOTES, 'UTF-8') ?></span>
                            </button>

                            <a href="/contents/npc/<?= urlencode($recording->npcId) ?>/comments/<?= urlencode($recording->id) ?>"
                                class="cast-comment-btn">
                                <span class="vote-icon">&#128172;</span>
                                <span
                                    class="vote-count"><?= htmlspecialchars($recording->comments, ENT_QUOTES, 'UTF-8') ?></span>
                            </a>
                        </div>
                    </div>
                <?php endforeach ?>
            </div>
        </div>
        <?php endif ?>
    <?php endforeach ?>
</section>

<div class="cast-back-wrapper">
    <button class="cast-back-btn" onclick="history.go(-1)">
        <span class="back-arrow">&larr;</span> Go Back
    </button>
</div>